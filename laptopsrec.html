<DOCTYPE html>
<html lang="en">
    <html>
<head>
  <title>Product Search</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/umd/supabase.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .product {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    .product h3 {
      margin: 0;
    }
    .product p {
      margin: 5px 0;
    }
    .product a {
      text-decoration: none;
      color: blue;
    }
  </style>
</head>
<body>
<h1>Product Search</h1>
<div id="results"> Loading products...</div>

<script>
  const SUPABASE_URL = 'https://cqtzjzggrllclhaxxjpy.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxdHpqemdncmxsY2xoYXh4anB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMTM4MjAsImV4cCI6MjA2MzY4OTgyMH0.R0NjWKx4TTurzJ3K-FRrNUGYGvNV_-lHY_m25M8J1S0';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const params = new URLSearchParams(window.location.search);
  const price = parseFloat(params.get('price'));
  const sizes = params.get('sizes')?.split(',') || [];
  const features = params.get('features')?.split(',') || [];

  async function fetchProducts() {
    let query = supabase
      .from('products')
      .select('*')
      .eq('category', 'laptop')
      .lte('price', price);

    // Apply filters
    if (sizes.length) {
      query = query.in('size', sizes);
    }
    if (features.length) {
      for (let feat of features) {
        query = query.contains('features', [feat]); // assuming features is a text[] or JSONB array
      }
    }

    const { data, error } = await query;

    const resultsDiv = document.getElementById('results');

    if (error) {
      console.error(error);
      resultsDiv.innerText = 'Error loading products';
      return;
    }

    if (!data.length) {
      resultsDiv.innerHTML = '<p>No matching laptops.</p>';
      return;
    }

    resultsDiv.innerHTML = data.map(p =>
      `<div class="product">
        <h3>$${p.price}</h3>
        <p>${JSON.stringify(p.specs)}</p>
        <a href="${p.link}" target="_blank">Buy</a>
      </div>`
    ).join('');
  }

  fetchProducts();
</script>

</html>
</body>
